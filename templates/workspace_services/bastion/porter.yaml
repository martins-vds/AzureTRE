---
schemaVersion: 1.0.0
name: tre-service-bastion
version: 0.0.5
description: "An Azure TRE service for Azure Bastion"
dockerfile: Dockerfile.tmpl
registry: azuretre

mixins:
  - az:
      clientVersion: 2.55.0
  - exec

credentials:
  - name: azure_tenant_id
    env: ARM_TENANT_ID
  - name: azure_subscription_id
    env: ARM_SUBSCRIPTION_ID
  - name: azure_client_id
    env: ARM_CLIENT_ID
  - name: azure_client_secret
    env: ARM_CLIENT_SECRET

parameters:
  - name: workspace_id
    type: string
  - name: tre_id
    type: string
  - name: bastion_subscription_id
    type: string
    description: "Subscription containing the Azure Bastion service"
  - name: bastion_resource_group
    type: string
    description: "Resource group containing the Azure Bastion service"
  - name: bastion_name
    type: string
    description: "The name of the Azure Bastion service"
  # the following are added automatically by the resource processor
  - name: id
    type: string
    description: "An Id for this installation"
    env: id
  - name: tfstate_resource_group_name
    type: string
    description: "Resource group containing the Terraform state storage account"
  - name: tfstate_storage_account_name
    type: string
    description: "The name of the Terraform state storage account"
  - name: tfstate_container_name
    env: tfstate_container_name
    type: string
    default: "tfstate"
    description: "The name of the Terraform state storage container"
  - name: arm_use_msi
    env: ARM_USE_MSI
    type: boolean
    default: false
  - name: arm_environment
    type: string

outputs:
- name: bastion_subscription_id
  type: string
  applyTo:
    - install
- name: bastion_resource_group
  type: string
  applyTo:
    - install
- name: bastion_name
  type: string
  applyTo:
    - install

install:
  - az:
      description: "Login to Azure"
      arguments:
        - login
      flags:
        identity:
        username: ${ bundle.credentials.azure_client_id }
  - az:
      arguments:
        - account
        - set
      flags:
        subscription: ${bundle.parameters.bastion_subscription_id}
  - az:
      arguments:
        - account
        - show
      outputs:
        - name: bastion_subscription_id
          jsonPath: "$.id"
  - az:
      arguments:
        - extension
        - add
      flags:
        name: bastion
        upgrade:
        yes:
  - az:
      arguments:
        - network
        - bastion
        - show
      flags:
        resource-group: ${bundle.parameters.bastion_resource_group}
        name: ${bundle.parameters.bastion_name}
      outputs:
        - name: bastion_name
          jsonPath: "$.name"
        - name: bastion_resource_group
          jsonPath: "$.resourceGroup"

upgrade:
  - exec:
      command: echo "Upgrade not supported yet"

uninstall:
  - exec:
      command: echo "Uninstall not supported yet"

